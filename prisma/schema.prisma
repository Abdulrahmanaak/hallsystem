// Prisma Schema for Hall Management System
// Multi-tenant Hall Management with Qoyod Integration

generator client {
  provider = "prisma-client"
  output   = "./generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// User Management (Multi-Tenant)
// ============================================

// Roles: SUPER_ADMIN, HALL_OWNER, ROOM_SUPERVISOR, ACCOUNTANT, EMPLOYEE

model User {
  id        String     @id @default(cuid())
  username  String     @unique
  password  String     // bcrypt hashed
  nameAr    String     // Arabic name: الاسم / Company name for hall owners
  email     String?    @unique
  phone     String?
  role      String     // UserRole: SUPER_ADMIN, HALL_OWNER, ROOM_SUPERVISOR, ACCOUNTANT, EMPLOYEE
  status    String     @default("ACTIVE") // UserStatus
  
  // Multi-tenant: For HALL_OWNER, ownerId is null (they are the owner)
  // For team members (ROOM_SUPERVISOR, ACCOUNTANT, EMPLOYEE), ownerId points to their hall owner
  ownerId   String?
  owner     User?      @relation("TenantOwner", fields: [ownerId], references: [id])
  teamMembers User[]   @relation("TenantOwner")
  
  // Hall Owner specific fields (populated when role = HALL_OWNER)
  commercialRegNo String?  // رقم السجل التجاري
  vatRegNo        String?  // رقم التسجيل الضريبي
  
  // Audit trail
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  lastLogin DateTime?
  
  // Relations for created/updated records
  createdBookings   Booking[]  @relation("BookingCreatedBy")
  updatedBookings   Booking[]  @relation("BookingUpdatedBy")
  createdCustomers  Customer[] @relation("CustomerCreatedBy")
  createdInvoices   Invoice[]  @relation("InvoiceCreatedBy")
  createdPayments   Payment[]  @relation("PaymentCreatedBy")
  createdExpenses   Expense[]  @relation("ExpenseCreatedBy")
  
  // Relations for owned data (tenant isolation)
  ownedHalls      Hall[]     @relation("HallOwner")
  ownedBookings   Booking[]  @relation("BookingOwner")
  ownedCustomers  Customer[] @relation("CustomerOwner")
  ownedInvoices   Invoice[]  @relation("InvoiceOwner")
  ownedPayments   Payment[]  @relation("PaymentOwner")
  ownedSettings   Settings?  @relation("SettingsOwner")
  
  @@index([ownerId])
  @@map("users")
}

// ============================================
// Customer Management
// ============================================

model Customer {
  id            String       @id @default(cuid())
  nameAr        String       // الاسم (Arabic)
  phone         String
  email         String?
  idNumber      String?      // رقم الهوية
  address       String?      // العنوان
  customerType  String       @default("INDIVIDUAL") // CustomerType
  notes         String?      // ملاحظات
  
  // Multi-tenant
  ownerId       String
  owner         User         @relation("CustomerOwner", fields: [ownerId], references: [id])
  
  // Qoyod Integration
  qoyodCustomerId String?    // ID from Qoyod system
  syncedToQoyod   Boolean    @default(false)
  lastSyncAt      DateTime?
  
  // Soft delete
  isDeleted     Boolean      @default(false)
  deletedAt     DateTime?
  
  // Audit trail
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  createdById   String
  createdBy     User         @relation("CustomerCreatedBy", fields: [createdById], references: [id])
  
  // Relations
  bookings      Booking[]
  invoices      Invoice[]
  
  @@index([phone])
  @@index([isDeleted])
  @@index([ownerId])
  @@index([syncedToQoyod])
  @@map("customers")
}

// ============================================
// Hall/Room Management
// ============================================

model Hall {
  id            String     @id @default(cuid())
  nameAr        String     // اسم القاعة
  capacity      Int        // السعة (number of guests)
  basePrice     Decimal    // Base rental price
  hourlyRate    Decimal?   // Optional hourly rate
  
  // Amenities (stored as JSON string)
  amenities     String?    // JSON string: {chairs: true, tables: true...}
  
  location      String?    // Location/floor
  description   String?    // وصف القاعة
  status        String     @default("ACTIVE") // HallStatus
  
  // Multi-tenant
  ownerId       String
  owner         User       @relation("HallOwner", fields: [ownerId], references: [id])
  
  // Service Defaults
  defaultCoffeeServers  Int?      @default(0)
  defaultSacrifices     Int?      @default(0)
  defaultWaterCartons   Int?      @default(0)
  coffeeServerPrice     Decimal?  @default(100)
  sacrificePrice        Decimal?  @default(1500)
  waterCartonPrice      Decimal?  @default(50)
  extraSectionPrice     Decimal?  @default(0)
  
  // Booking Defaults
  defaultGuestCount     Int?
  defaultSectionType    String?   @default("both") // men, women, both
  
  // Meal Prices (stored as JSON)
  mealPrices            String?   // JSON: { dinner, lunch, breakfast, snacks }
  
  // Soft delete
  isDeleted     Boolean    @default(false)
  deletedAt     DateTime?
  
  // Audit trail
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  
  // Relations
  bookings      Booking[]
  
  @@index([status])
  @@index([isDeleted])
  @@index([ownerId])
  @@map("halls")
}

// ============================================
// Booking Management
// ============================================

model Booking {
  id              String        @id @default(cuid())
  bookingNumber   String        @unique // Auto-generated: BK-2025-0001
  
  // Customer & Hall
  customerId      String
  customer        Customer      @relation(fields: [customerId], references: [id])
  hallId          String
  hall            Hall          @relation(fields: [hallId], references: [id])
  
  // Multi-tenant
  ownerId         String
  owner           User          @relation("BookingOwner", fields: [ownerId], references: [id])
  
  // Event Details
  eventType       String        // EventType
  eventDate       DateTime      // تاريخ المناسبة
  startTime       DateTime      // وقت البداية
  endTime         DateTime      // وقت النهاية
  guestCount      Int?          // عدد الضيوف
  sectionType     String?       // "MEN", "WOMEN", "BOTH"
  mealType        String?       // "DINNER", "LUNCH", "BREAKFAST"
  services        String?       // JSON string of selected service IDs
  coffeeServers   Int?          // Number of coffee servers (صبابين)
  sacrifices      Int?          // Number of sacrifices (ذبائح)
  waterCartons    Int?          // Number of water cartons (كراتين ماء)
  notes           String?       // ملاحظات
  
  // Financial
  totalAmount     Decimal       
  downPayment     Decimal       @default(0) // العربون
  discountAmount  Decimal       @default(0) 
  vatAmount       Decimal       
  finalAmount     Decimal
  serviceRevenue  Decimal       @default(0) // Internal value of included services (for Qoyod)
  servicesBreakdown String?     // JSON: {"coffee": 500, "water": 200, "sacrifice": 1500}       
  
  // Status
  status          String        @default("PENDING") // BookingStatus
  
  // Soft delete
  isDeleted       Boolean       @default(false)
  deletedAt       DateTime?
  
  // Audit trail
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  createdById     String
  createdBy       User          @relation("BookingCreatedBy", fields: [createdById], references: [id])
  updatedById     String?
  updatedBy       User?         @relation("BookingUpdatedBy", fields: [updatedById], references: [id])
  
  // Relations
  invoices        Invoice[]
  payments        Payment[]
  statusHistory   BookingStatusHistory[]
  
  @@index([bookingNumber])
  @@index([eventDate])
  @@index([status])
  @@index([customerId])
  @@index([hallId])
  @@index([isDeleted])
  @@index([ownerId])
  @@map("bookings")
}

// Track booking status changes
model BookingStatusHistory {
  id          String        @id @default(cuid())
  bookingId   String
  booking     Booking       @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  
  fromStatus  String?       // BookingStatus
  toStatus    String        // BookingStatus
  notes       String?
  
  createdAt   DateTime      @default(now())
  createdById String?
  
  @@index([bookingId])
  @@map("booking_status_history")
}

// ============================================
// Financial Management - Basic Tracking
// ============================================

model Invoice {
  id              String        @id @default(cuid())
  invoiceNumber   String        @unique // Auto-generated: INV-2025-0001
  
  // Relations
  bookingId       String
  booking         Booking       @relation(fields: [bookingId], references: [id])
  customerId      String
  customer        Customer      @relation(fields: [customerId], references: [id])
  
  // Multi-tenant
  ownerId         String
  owner           User          @relation("InvoiceOwner", fields: [ownerId], references: [id])
  
  // Amounts
  subtotal        Decimal       
  discountAmount  Decimal       @default(0) 
  vatAmount       Decimal       
  totalAmount     Decimal       
  paidAmount      Decimal       @default(0) 
  
  // Dates
  issueDate       DateTime      @default(now())
  dueDate         DateTime
  
  // Status
  status          String        @default("UNPAID") // InvoiceStatus
  
  // Qoyod Integration
  qoyodInvoiceId  String?       // ID from Qoyod system
  syncedToQoyod   Boolean       @default(false)
  lastSyncAt      DateTime?
  
  // Notes
  notes           String?
  
  // Soft delete
  isDeleted       Boolean       @default(false)
  deletedAt       DateTime?
  
  // Audit trail
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  createdById     String
  createdBy       User          @relation("InvoiceCreatedBy", fields: [createdById], references: [id])
  
  // Relations
  payments        Payment[]
  
  @@index([invoiceNumber])
  @@index([status])
  @@index([dueDate])
  @@index([syncedToQoyod])
  @@index([isDeleted])
  @@index([ownerId])
  @@map("invoices")
}

// ============================================
// Payment Tracking
// ============================================

model Payment {
  id              String        @id @default(cuid())
  paymentNumber   String        @unique // Auto-generated: PAY-2025-0001
  
  // Relations
  bookingId       String
  booking         Booking       @relation(fields: [bookingId], references: [id])
  invoiceId       String?
  invoice         Invoice?      @relation(fields: [invoiceId], references: [id])
  
  // Multi-tenant
  ownerId         String
  owner           User          @relation("PaymentOwner", fields: [ownerId], references: [id])
  
  // Payment Details
  amount          Decimal       
  paymentMethod   String        // PaymentMethod
  paymentDate     DateTime      @default(now())
  notes           String?
  
  // Qoyod Integration
  qoyodPaymentId  String?       // ID from Qoyod system
  syncedToQoyod   Boolean       @default(false)
  lastSyncAt      DateTime?
  
  // Soft delete
  isDeleted       Boolean       @default(false)
  deletedAt       DateTime?
  
  // Audit trail
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  createdById     String
  createdBy       User          @relation("PaymentCreatedBy", fields: [createdById], references: [id])
  
  @@index([paymentNumber])
  @@index([paymentDate])
  @@index([syncedToQoyod])
  @@index([isDeleted])
  @@index([ownerId])
  @@map("payments")
}

// ============================================
// Settings & Configuration (Per Tenant)
// ============================================

model Settings {
  id                String   @id @default(cuid())
  
  // Multi-tenant - one settings per hall owner
  ownerId           String   @unique
  owner             User     @relation("SettingsOwner", fields: [ownerId], references: [id])
  
  // Company Information
  companyNameAr     String   @default("نظام إدارة القاعات")
  companyLogo       String?
  companyPhone      String?
  companyEmail      String?
  companyAddress    String?
  companyAddressLine2 String?  // السطر الثاني للعنوان
  commercialRegNo   String?  // رقم السجل التجاري
  vatRegNo          String?  // رقم التسجيل الضريبي
  
  // Financial Settings
  vatPercentage     Decimal  @default(15) 
  
  // Qoyod Integration
  qoyodApiKey               String?
  qoyodApiSecret            String?
  qoyodEnabled              Boolean  @default(false)
  qoyodDefaultBankAccountId String?  // For payment deposits (Cash/Bank account)
  qoyodDefaultSalesAccountId String? // For revenue recording
  qoyodAutoSync             Boolean  @default(true)  // Auto-sync on creation
  
  // Audit trail
  updatedAt         DateTime @updatedAt
  
  @@map("settings")
}

// ============================================
// Accounting Sync Log (Qoyod POC)
// ============================================

model AccountingSync {
  id              String     @id @default(cuid())
  
  syncType        String     // SyncType
  recordId        String     // ID of the record being synced
  recordType      String     // Model name: Booking, Invoice, Payment, Customer
  
  // Qoyod Response
  qoyodId         String?    // ID returned from Qoyod
  status          String     @default("PENDING") // SyncStatus
  errorMessage    String?    // Error details if failed
  
  // Request/Response data (for debugging)
  requestData     String?    // JSON string
  responseData    String?    // JSON string
  
  // Timing
  createdAt       DateTime   @default(now())
  completedAt     DateTime?
  
  @@index([recordId])
  @@index([status])
  @@index([createdAt])
  @@map("accounting_sync_log")
}


model Expense {
  id              String   @id @default(cuid())
  amount          Decimal
  description     String
  expenseDate     DateTime
  category        String?
  imageUrl        String?
  
  // Relations
  createdById     String
  createdBy       User     @relation("ExpenseCreatedBy", fields: [createdById], references: [id])
  
  ownerId         String?  // For multi-tenancy
  
  // Qoyod Sync
  syncedToQoyod   Boolean  @default(false)
  qoyodExpenseId  String?
  lastSyncAt      DateTime?

  // Vendor Link
  vendorId        String?
  vendor          Vendor?  @relation(fields: [vendorId], references: [id])

  // Soft Delete
  isDeleted       Boolean  @default(false)
  deletedAt       DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([ownerId])
  @@index([createdById])
  @@map("expenses")
}

model Vendor {
  id              String   @id @default(cuid())
  nameAr          String
  nameEn          String?
  phone           String?
  email           String?
  
  // Qoyod Sync
  qoyodVendorId   String?  // ID from Qoyod
  
  ownerId         String
  
  expenses        Expense[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([ownerId])
  @@map("vendors")
}

// ============================================
// Password Reset Tokens
// ============================================

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())
  
  @@unique([email, token])
  @@map("password_reset_tokens")
}
